# 🌱 우리아이도서관 (woorilib) 고도화 구현 계획 v2

> **작성일**: 2026-01-19
> **버전**: 2.0 (사용자 피드백 반영)

---

## 🗺️ 지도 구현 전략

### 고민: 메인에 항상 표시 vs 클릭 시 표시

| 방식 | 장점 | 단점 |
|------|------|------|
| **메인에 항상 표시** | 직관적, 한눈에 파악 | 화면 차지 큼, 모바일에서 스크롤 필요 |
| **클릭 시 표시 (모달/시트)** | 화면 효율적, 필요할 때만 | 한 번 더 탭해야 함 |
| **책 상세 페이지에서 표시** | 맥락에 맞음 (책 구하기 단계) | 홈에서 바로 접근 불가 |

### 💡 추천 방식: **하이브리드**

```
[홈 화면]
├─ 인기 도서, 추천 등 콘텐츠
└─ 하단 네비게이션에 "🗺️ 지도" 탭 추가

[책 상세 페이지 - 4Way 획득 패널]
├─ 🏛️ 도서관 (8개 소장) → 탭하면 지도 모달
└─ 📖 알라딘 중고 (3개 매장) → 탭하면 지도 모달
```

**이유**:
1. 홈에서 항상 보여주면 "책 구하기" 목적과 맞지 않음
2. 특정 책을 선택한 후 → 어디서 구할 수 있는지 지도로 보는 게 자연스러운 흐름
3. 별도 "지도" 탭은 "내 주변 도서관 탐색" 용도로 활용

---

### 알라딘 오프라인 매장 지도 표시

**API 현황 확인**:
```
ItemOffStoreList API 응답:
- offCode: 매장 코드
- offName: 매장명 (예: "강남점", "홍대점")
- hasStock: 재고 여부 (1/0)
- location: 매장 내 서가 위치

❌ 매장 주소, 위경도 좌표 없음
```

**해결책: 정적 데이터 관리**

알라딘 중고매장은 전국 약 **50개** 내외로 고정적이므로:

```typescript
// shared/data/aladin-stores.ts
export const ALADIN_STORES = [
  {
    offCode: "Gangnam",
    name: "강남점",
    address: "서울시 강남구 강남대로 ...",
    lat: 37.4979,
    lng: 127.0276,
    tel: "02-1234-5678",
  },
  {
    offCode: "Hongdae",
    name: "홍대점",
    address: "서울시 마포구 양화로 ...",
    lat: 37.5563,
    lng: 126.9220,
    tel: "02-2345-6789",
  },
  // ... 전국 매장
];
```

**데이터 수집 방법**:
1. 알라딘 중고매장 페이지에서 매장 목록 확인
2. 주소 수집 후 카카오 지오코딩 API로 좌표 변환
3. 한 번 수집 후 정적 파일로 관리 (매장 변동 시 수동 업데이트)

---

### 지도 상세정보 팝업

**클릭 시 표시할 정보**:

#### 도서관 상세정보 (도서관나루 API)
```
┌─────────────────────────────┐
│ 🏛️ 광명시립도서관           │
├─────────────────────────────┤
│ 📍 경기도 광명시 오리로 ... │
│ 📞 02-1234-5678            │
│ 🕐 09:00 ~ 18:00           │
│ 📅 휴관: 매주 월요일        │
│ 📏 내 위치에서 1.2km        │
├─────────────────────────────┤
│ [🌐 홈페이지] [📞 전화]     │
│ [🧭 길찾기]                 │
└─────────────────────────────┘
```

**표시 데이터** (libSrchByBook API):
- libName (도서관명)
- address (주소)
- tel (전화번호)
- operatingTime (운영시간)
- closed (휴관일)
- homepage (홈페이지 링크)
- 거리 계산 (사용자 위치 기반)

#### 알라딘 매장 상세정보
```
┌─────────────────────────────┐
│ 📖 알라딘 강남점             │
├─────────────────────────────┤
│ 📍 서울시 강남구 ...        │
│ 📞 02-1234-5678            │
│ 📏 내 위치에서 3.5km        │
├─────────────────────────────┤
│ 📚 이 책 재고: 있음          │
│ 📍 서가 위치: A구역 3층     │
│ ⚠️ 재고는 변동될 수 있어요  │
├─────────────────────────────┤
│ [🌐 매장페이지] [📞 전화]   │
│ [🧭 길찾기]                 │
└─────────────────────────────┘
```

**표시 데이터**:
- 정적 데이터: name, address, tel, lat, lng
- API 데이터: hasStock, location (서가 위치)

---

## 📋 수정된 구현 계획

### Phase 1: 핵심 기능

#### 1.1 지도 기능 ⭐⭐⭐
**구현 위치**: 책 상세 페이지 → 획득 패널에서 접근

**기능**:
- 도서관 + 알라딘 매장 동시 표시 (마커 색상 구분)
- 마커 클릭 시 상세정보 팝업
- 내 위치 표시 + 거리 계산
- 필터: 도서관만 / 알라딘만 / 전체

**마커 구분**:
- 🟢 도서관 (소장중)
- 🟣 알라딘 매장 (재고있음)
- ⚫ 알라딘 매장 (재고없음) - 반투명 처리

**참조**: `library-finder/features/library-map/ui/LibraryMap.tsx`

---

#### 1.2 알라딘 중고 가격 + 매장 재고 ⭐⭐⭐

**온라인 중고 가격** (API 직접 조회):
```
📖 알라딘 중고
├─ 💰 온라인 최저가: 5,500원
│   └─ 알라딘직배송 / 무료배송
└─ 🏪 오프라인 매장 (3개 매장 재고)
    └─ 지도에서 확인하기 →
```

**필수 안내 문구**:
- "⚠️ 오프라인 재고는 변동될 수 있어요"
- "방문 전 전화 확인을 권장해요"

---

#### 1.3 가족 관리 (다자녀) ⭐⭐⭐ ✅ 진행

**구현 내용**:
- 자녀 프로필 CRUD (이름, 생년월일, 아바타 이모지)
- 자녀별 책장 분리
- 자녀별 독서 통계
- 자녀 전환 UI

**데이터 구조**:
```typescript
interface Child {
  id: string;
  name: string;
  birthDate: string; // YYYY-MM-DD
  avatar: string; // 이모지: 👶🧒👦👧
  createdAt: string;
}
```

**Supabase 테이블**:
```sql
create table children (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users(id),
  name text not null,
  birth_date date not null,
  avatar text default '👶',
  created_at timestamptz default now()
);
```

**참조**: `library-finder/features/family/`

---

#### ~~1.4 절약 계산기~~ ❌ 보류
> 사용자 의견: 부정확하고 번거로움

---

### Phase 2: 사용자 경험 개선

#### 2.1 간편 독서 기록 ⭐⭐⭐ ✅ 구현

**목표**: 최소 탭으로 기록 완료

**Flow 1: 책 상세 페이지에서**
```
[책 상세] → [✅ 읽었어요] 버튼
    ↓
[자녀 선택] (다자녀인 경우)
    ↓
[감상 선택] (선택사항, 건너뛰기 가능)
    ↓
완료! 🎉
```

**감상 선택지**:
| 이모지 | 의미 |
|--------|------|
| 😆 | 재미있었어요 |
| ❤️ | 감동이었어요 |
| 🤔 | 어려웠어요 |
| 😴 | 지루했어요 |
| ⏭️ | 건너뛰기 |

**참조**: `library-finder/features/reading-record/`

---

#### 2.2 비슷한 책 추천 ⭐⭐ ✅ 구현

**API**: 도서관나루 `recommandList`
```
GET /api/recommandList?isbn13={ISBN}&type=reader
→ "이 책을 빌린 사람들이 함께 빌린 책"
```

**표시**:
```
📚 이 책을 좋아한 아이들이 함께 읽은 책
├─ [책 표지] 슈퍼 토끼
├─ [책 표지] 구름빵
├─ [책 표지] 팥빙수의 전설
└─ 더보기 →
```

---

#### 2.3 PWA 설정 ⭐⭐ ✅ 구현

**구현**:
```typescript
// app/manifest.ts
export default function manifest() {
  return {
    name: '우리아이도서관',
    short_name: '우리아이도서관',
    description: '우리 아이 책, 현명하게 골라 합리적으로 구해요',
    start_url: '/',
    display: 'standalone',
    background_color: '#FFFEF5',
    theme_color: '#2E7D32',
    icons: [
      { src: '/icon-192.png', sizes: '192x192', type: 'image/png' },
      { src: '/icon-512.png', sizes: '512x512', type: 'image/png' },
    ],
  };
}
```

**추가 작업**:
- 아이콘 제작 (192x192, 512x512)
- iOS Safari용 apple-touch-icon
- 스플래시 스크린 (선택)

---

### Phase 3: 소셜 & 추천 시스템

#### 3.1 또래 인기 도서 ⭐⭐⭐ ✅ 구현 (수정됨)

> **사용자 피드백 반영**:
> - 동네 기반 ❌ → 또래 기반 ✅
> - 엄마들은 동네보다 **대형 온라인 서점 인기 순위**나 **전집**을 참고
> - 전집 = 영역별 커리큘럼이 한방에 해결되어 인기

**구현 방향**:

##### A. 또래 인기 도서 (우리 서비스 데이터 기반)
```
👶 5세 또래들이 많이 읽는 책
├─ 1. 슈퍼 거북 (또래 127명이 읽었어요)
├─ 2. 구름빵 (또래 98명이 읽었어요)
├─ 3. 팥빙수의 전설 (또래 87명이 읽었어요)
└─ 더보기 →
```

**데이터 집계**:
```sql
-- 또래(같은 나이) 독서 기록 집계
SELECT
  book_isbn,
  COUNT(*) as read_count
FROM reading_records r
JOIN children c ON r.child_id = c.id
WHERE
  EXTRACT(YEAR FROM AGE(c.birth_date)) = 5 -- 5세
GROUP BY book_isbn
ORDER BY read_count DESC
LIMIT 10;
```

##### B. 베스트셀러 연동 (알라딘 API)
```
🏆 유아 베스트셀러 TOP 10
├─ [알라딘 유아 분야 베스트셀러]
└─ 카테고리: 그림책 / 동화 / 학습
```

**API**: `ItemList?QueryType=Bestseller&CategoryId=1108` (유아)

##### C. 전집 정보 섹션 (API 기반)
```
📚 인기 전집/시리즈
├─ 🎨 그림책 시리즈 베스트
├─ 🔬 과학 전집 베스트
├─ 🌍 세계명작 시리즈
└─ 더보기 →
```

**구현 방식 (API 기반)**:
- 알라딘 API: `ItemList?QueryType=Bestseller&CategoryId={전집카테고리}`
- 도서관나루 API: 인기대출 도서 중 시리즈물 필터링
- "전집", "시리즈", "세트" 키워드로 검색하여 자동 수집

##### D. 한줄평 기능
```
📝 또래 엄마들의 한줄평
├─ "우리 애가 100번은 읽었어요" - 5세 엄마
├─ "잠자기 전에 꼭 읽어달라고 해요" - 4세 엄마
└─ 한줄평 쓰기 →
```

**범위 제한** (유지):
- 댓글/대화 기능 없음
- 책에 대한 한줄평만 가능
- 신고 기능으로 부적절 콘텐츠 관리

---

#### 3.2 또래 비교 ⭐⭐ ✅ 구현 (3.1과 안 겹치는 부분)

> 3.1에서 "또래 N명이 읽었어요"는 책 단위
> 3.2는 **우리 아이 vs 또래 평균** 비교

**표시**:
```
📊 우리 아이 독서 리포트

📚 이번 달 독서량
├─ 우리 아이: 8권
├─ 5세 평균: 4.2권
└─ 🏆 상위 15%!

📖 읽은 분야
├─ 그림책: 5권 (또래 평균 3권)
├─ 과학: 2권 (또래 평균 1권)
└─ 창작동화: 1권 (또래 평균 2권)

💬 "과학책을 또래보다 많이 읽고 있어요!
    이런 책은 어때요?" → [추천 책 보기]
```

**차별점**:
- 3.1: 또래가 **어떤 책**을 많이 읽는지
- 3.2: 우리 아이가 또래 대비 **얼마나** 읽는지 + **어떤 분야**를 읽는지

---

#### 3.3 독서 챌린지 & 뱃지 ⭐⭐ ✅ 구현

**챌린지 시스템** (내용은 추후 조정 가능):

```typescript
interface Challenge {
  id: string;
  title: string;
  description: string;
  type: 'weekly' | 'monthly' | 'achievement';
  goal: number;
  reward: Badge;
}

// 예시 챌린지
const challenges = [
  {
    id: 'weekly-3',
    title: '이번 주 3권 읽기',
    type: 'weekly',
    goal: 3,
  },
  {
    id: 'diverse-5',
    title: '다양한 분야 5가지 도전',
    type: 'achievement',
    goal: 5,
  },
  {
    id: 'library-5',
    title: '도서관에서 5권 빌리기',
    type: 'monthly',
    goal: 5,
  },
];
```

**뱃지 시스템**:
| 뱃지 | 조건 | 아이콘 |
|------|------|--------|
| 첫 독서 | 첫 책 기록 | 🌱 |
| 독서왕 | 월 10권 | 👑 |
| 꾸준함 | 7일 연속 | 🔥 |
| 탐험가 | 5개 분야 | 🧭 |
| 도서관 마스터 | 도서관 20권 | 🏛️ |

**UI**:
```
🎯 이번 주 챌린지
├─ [ ] 이번 주 3권 읽기 (1/3)
├─ [✓] 새로운 작가 책 읽기 ✅
└─ 달성 시 뱃지 획득!

🎖️ 내 뱃지 (5개)
[🌱] [👑] [🔥] [🧭] [🏛️]
```

---

### Phase 4: 시각화 & UX 개선

#### 4.1 독서 타임라인 ⭐

```
📅 2024년 독서 기록

[1월] 📚📚📚📚📚 (5권)
[2월] 📚📚📚📚📚📚📚 (7권)
[3월] 📚📚📚 (3권)
...

👶 3세 때 읽은 책들
[책 표지 그리드 - 가로 스크롤]
```

---

#### 4.2 빠른 액션 버튼 ⭐

**검색 결과 카드**:
```
┌─────────────────────────────┐
│ [책 표지]  슈퍼 거북        │
│            유설화 | 책읽는곰 │
│                             │
│  [❤️] [🏛️] [📤]           │
│  담기  도서관 공유          │
└─────────────────────────────┘
```

---

#### 4.3 성장 그래프 ⭐

```
📈 독서량 변화

     8권
      │    ╭─╮
   6권│  ╭─╯ ╰─╮
      │╭─╯     ╰─╮
   4권├╯         ╰─
      │
   2권│
      └─────────────────
       1월 2월 3월 4월 5월

💬 "꾸준히 늘고 있어요! 대단해요 💪"
```

---

## 🚫 구현 안 함 (명확한 사유)

| 기능 | 이유 |
|------|------|
| 실시간 대출 상태 | API 미지원, 신뢰도 문제 |
| 절약 계산기 | 부정확, 번거로움 (사용자 피드백) |
| 당근마켓 가격 예측 | API 없음, 신뢰할 수 없음 |
| 당근마켓 알림 | 크롤링 불법 위험 |
| 반납 예정일 자동 알림 | 자동화 불가, 사용자 부담 |
| 책 교환 제안 | 채팅 등 구현 범위 너무 큼 |
| 음성/이미지 검색 | 구현 난이도 대비 필요성 낮음 |

---

## 📅 구현 우선순위

### Sprint 1 (1주차): 인프라 + 지도
- [ ] 알라딘 API 키 문제 해결
- [ ] 알라딘 매장 정적 데이터 수집 (주소, 좌표)
- [ ] 카카오맵 통합 (도서관 + 알라딘 동시 표시)
- [ ] 마커 클릭 시 상세정보 팝업

### Sprint 2 (2주차): 가족 + 독서기록
- [ ] 가족 관리 기능 (다자녀)
- [ ] 간편 독서 기록 (2탭 완료)
- [ ] 자녀별 책장 분리

### Sprint 3 (3주차): 추천 + 소셜
- [ ] 또래 인기 도서 (서비스 데이터 기반)
- [ ] 알라딘 베스트셀러 연동
- [ ] 비슷한 책 추천 (recommandList)
- [ ] 한줄평 기능

### Sprint 4 (4주차): 게임 + 시각화
- [ ] 또래 비교 대시보드
- [ ] 독서 챌린지 & 뱃지
- [ ] 독서 타임라인
- [ ] PWA 설정

---

## 📁 library-finder에서 가져올 파일

| 기능 | 파일 경로 | 우선순위 |
|------|----------|---------|
| 카카오맵 | `features/library-map/ui/LibraryMap.tsx` | P0 |
| 지도 상태관리 | `features/library-map/lib/use-map-store.ts` | P0 |
| 가족 스토어 | `features/family/model/use-family-store.ts` | P0 |
| 가족 API | `features/family/api/family.service.ts` | P0 |
| 독서 기록 | `features/reading-record/lib/use-reading-record.ts` | P0 |
| 독서 통계 UI | `features/my-bookshelf/ui/reading-stats.tsx` | P1 |
| PWA 매니페스트 | `app/manifest.ts` | P2 |

---

## 📝 알라딘 매장 데이터 수집 작업

**필요한 정보**:
```typescript
interface AladinStore {
  offCode: string;      // API에서 사용하는 코드
  name: string;         // 매장명
  address: string;      // 주소
  lat: number;          // 위도
  lng: number;          // 경도
  tel: string;          // 전화번호
  region: string;       // 지역 (서울, 경기 등)
}
```

**수집 순서**:
1. 알라딘 중고매장 페이지에서 전국 매장 목록 확인
2. 매장별 주소, 전화번호 수집
3. 카카오 지오코딩 API로 주소 → 좌표 변환
4. `shared/data/aladin-stores.ts` 파일로 저장

**예상 매장 수**: 약 50개 내외

---

## ✅ 최종 체크리스트

### 지도 관련
- [ ] 도서관 마커 (🟢)
- [ ] 알라딘 매장 마커 (🟣/⚫)
- [ ] 마커 클릭 시 상세정보
- [ ] 내 위치 표시
- [ ] 거리 계산
- [ ] 길찾기 연동

### 알라딘 관련
- [ ] "재고는 변동될 수 있어요" 안내
- [ ] 매장 전화번호 표시
- [ ] 서가 위치 정보 표시

### 또래 시스템
- [ ] 또래 인기 도서 집계 쿼리
- [ ] "또래 N명이 읽었어요" 표시
- [ ] 또래 비교 통계
- [ ] 한줄평 CRUD + 신고 기능
